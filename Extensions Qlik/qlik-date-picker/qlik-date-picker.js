/**
 * @license
 * Copyright 2018 Nodier Torres. All rights reserved.
 * 
 * Copyrights licensed under the terms of the MIT license.
 * Original source <https://github.com/NOD507/SenseDateRangePicker>
 */
define(["qlik","jquery","./lib/moment.min","./calendar-settings","./lib/encoder","css!./lib/daterangepicker.css","./lib/daterangepicker"],(function(qlik,$,moment,CalendarSettings,encoder){"use strict";function createDate(num){return moment(86400*(num-25569)*1e3).utc().format("YYYYMMDD").toString()}function createMoment(str,format){return isNaN(str)?moment.utc(str,format):moment.utc(createDate(str),"YYYYMMDD")}function createRanges(props){var ranges={},numberOf=props.numberOf,includeCurrent=props.previousOrLast;null==props.this&&(props.this="m"),null==props.thisLabel&&(props.thisLabel=props.thisMonth),null==props.last&&(props.last="m"),null==props.lastLabel&&(props.lastLabel=props.lastMonth),null==numberOf&&(numberOf=1),null==includeCurrent&&(includeCurrent=!1);const today=()=>{const localDate=moment(),localDateString=`${localDate.month()+1}/${localDate.date()}/${localDate.year()}`;return moment.utc(localDateString,"M/D/YYYY")};return ranges[props.today]=[today().startOf("day"),today().startOf("day")],ranges[props.yesterday]=[today().subtract(1,"days").startOf("day"),today().subtract(1,"days").startOf("day")],ranges[props.lastXDays.replace("$","7")]=[today().subtract(6,"days").startOf("day"),today().startOf("day")],ranges[props.lastXDays.replace("$","30")]=[today().subtract(29,"days").startOf("day"),today().startOf("day")],"d"===props.this?ranges[props.thisLabel]=[today().startOf("day"),today().startOf("day")]:"m"===props.this?ranges[props.thisLabel]=[today().startOf("month").startOf("day"),today().endOf("month").startOf("day")]:"q"===props.this?ranges[props.thisLabel]=[today().startOf("quarter").startOf("day"),today().endOf("quarter").startOf("day")]:"y"===props.this&&(ranges[props.thisLabel]=[today().startOf("year").startOf("day"),today().endOf("year").startOf("day")]),includeCurrent?"d"===props.last?ranges[props.lastLabel]=[today().subtract(numberOf-1,"days").startOf("day"),today().startOf("day")]:"m"===props.last?ranges[props.lastLabel]=[today().subtract(numberOf-1,"months").startOf("month").startOf("day"),today().endOf("month").startOf("day")]:"q"===props.last?ranges[props.lastLabel]=[today().subtract(numberOf-1,"quarters").startOf("quarter").startOf("day"),today().endOf("quarter").startOf("day")]:"y"===props.last&&(ranges[props.lastLabel]=[today().subtract(numberOf-1,"years").startOf("year").startOf("day"),today().endOf("year").startOf("day")]):"d"===props.last?ranges[props.lastLabel]=[today().subtract(numberOf,"days").startOf("day"),today().subtract(1,"days").startOf("day")]:"m"===props.last?ranges[props.lastLabel]=[today().subtract(numberOf,"months").startOf("month").startOf("day"),today().subtract(1,"months").endOf("month").startOf("day")]:"q"===props.last?ranges[props.lastLabel]=[today().subtract(numberOf,"quarters").startOf("quarter").startOf("day"),today().subtract(1,"quarters").endOf("quarter").startOf("day")]:"y"===props.last&&(ranges[props.lastLabel]=[today().subtract(numberOf,"years").startOf("year").startOf("day"),today().subtract(1,"years").endOf("year").startOf("day")]),ranges}function createDateStates(pages){var dateStates={};return pages.forEach((function(page){page.qMatrix.forEach((function(row){var d=createDate(row[0].qNum);dateStates[d]=row[0].qState,"S"===row[0].qState&&(dateStates.rangeEnd=dateStates.rangeEnd||row[0].qNum,dateStates.rangeStart=row[0].qNum)}))})),dateStates}function createHtml(dateStates,DateFormat,props,sortAscending){var startRange,endRange,html="<div>";return!function(obj){for(var key in obj)if(obj.hasOwnProperty(key))return!1;return!0}(dateStates)?(html+='<div class="bootstrap_inside pull-right show-range" >',html+='   <i class="lui-icon lui-icon--calendar"></i>&nbsp;<span>',dateStates.rangeStart?(startRange=createMoment(dateStates.rangeStart).format(DateFormat),endRange=dateStates.rangeEnd&&dateStates.rangeEnd!==dateStates.rangeStart?createMoment(dateStates.rangeEnd).format(DateFormat):null,sortAscending?html+=null!==endRange?encoder.encodeForHTML(endRange)+encoder.encodeForHTML(props.separator)+encoder.encodeForHTML(startRange):encoder.encodeForHTML(startRange):(html+=encoder.encodeForHTML(startRange),null!==endRange&&(html+=encoder.encodeForHTML(props.separator)+encoder.encodeForHTML(endRange)))):html+=encoder.encodeForHTML(props.defaultText),html+='</span> <b class="lui-button__caret lui-caret"></b>',html+="</div>"):(html+='   <i class="lui-icon lui-icon--calendar"></i>&nbsp;&nbsp;&nbsp;<span>',html+="Add Date Field</span>"),html+="</div>"}function getTopPosition(element){return $(window).height()-element.offset().top>310?"down":"up"}return{methods:{createDate:createDate,createMoment:createMoment,createRanges:createRanges,createDateStates:createDateStates,createHtml:createHtml},initialProperties:{version:1,qListObjectDef:{qDef:{autoSort:!1,qSortCriterias:[{qSortByNumeric:-1},{qSortByState:1}]},qShowAlternatives:!0,qFrequencyMode:"V",qInitialDataFetch:[{qWidth:1,qHeight:1e4}]},advanced:!1},exportProperties:null,importProperties:null,definition:CalendarSettings,support:{snapshot:!1,export:!1,exportData:!1},paint:function($element,layout){var self=this,interactionState=this._interactionState,noSelections=!0===this.options.noSelections,sortAscending=layout&&layout.qListObject&&layout.qListObject.qSortCriterias&&"1"==layout.qListObject.qSortCriterias.qSortByNumeric||layout&&layout.qListObject&&layout.qListObject.qDimensionInfo&&"A"==layout.qListObject.qDimensionInfo.qSortIndicator;this.dateStates=createDateStates(layout.qListObject.qDataPages),self.app||(self.app=qlik.currApp(this));var minDate,maxDate,startDate,endDate,qlikDateFormat=layout.qListObject.qDimensionInfo.qNumFormat.qFmt||self.app.model.layout.qLocaleInfo.qDateFmt,outDateFormat=layout.props.format||qlikDateFormat;moment.locale(layout.props.locale),minDate=createMoment(layout.props.minDate,qlikDateFormat),maxDate=createMoment(layout.props.maxDate,qlikDateFormat),startDate=createMoment(layout.props.startDate,qlikDateFormat),endDate=createMoment(layout.props.endDate,qlikDateFormat),$("#dropDown_"+layout.qInfo.qId).remove(),$element.html(createHtml(this.dateStates,outDateFormat,layout.props,sortAscending));var element,config={singleDatePicker:layout.props.isSingleDate,preventSelections:noSelections,locale:{format:outDateFormat,separator:layout.props.separator},parentEl:"#grid",autoUpdateInput:!1,autoApply:!0,opens:(element=$element,element.offset().left<600?"right":element.offset().right<600?"left":void 0),top:getTopPosition($element),id:layout.qInfo.qId,getClass:function(date){var d=date.format("YYYYMMDD");return self.dateStates[d]?"state"+self.dateStates[d]:"nodata"}};minDate.isValid()&&(config.minDate=minDate),maxDate.isValid()&&(config.maxDate=maxDate),startDate.isValid()?config.startDate=startDate:config.startDate=config.minDate,endDate.isValid()?config.endDate=endDate:config.endDate=config.maxDate,layout.props.CustomRangesEnabled&&(config.locale.customRangeLabel=layout.props.customRangeLabel,config.ranges=createRanges(layout.props)),1===interactionState&&$element.find(".show-range").qlikdaterangepicker(config,(function(pickStart,pickEnd,label){if(!noSelections&&pickStart.isValid()&&pickEnd.isValid()){var pickStartString,pickEndString,lastIndex,lowIndex,highIndex,qElemNumbers;-1===qlikDateFormat.indexOf("#")?(pickStartString=moment.utc(pickStart.format("YYYYMMDD").toString(),"YYYYMMDD").format(qlikDateFormat),pickEndString=moment.utc(pickEnd.format("YYYYMMDD").toString(),"YYYYMMDD").format(qlikDateFormat),pickStart=createMoment(pickStartString,qlikDateFormat),pickEnd=createMoment(pickEndString,qlikDateFormat)):(pickStart=moment.utc(pickStart.format("YYYYMMDD").toString(),"YYYYMMDD"),pickEnd=moment.utc(pickEnd.format("YYYYMMDD").toString(),"YYYYMMDD"));var dateBinarySearch=function(seachDate,lowIndex,highIndex){if(lowIndex===highIndex)return lowIndex;var middleIndex=lowIndex+Math.ceil((highIndex-lowIndex)/2),middleDate=createMoment(layout.qListObject.qDataPages[0].qMatrix[middleIndex][0].qText,qlikDateFormat);if(sortAscending){if(seachDate.isBefore(middleDate))return dateBinarySearch(seachDate,lowIndex,middleIndex-1)}else if(seachDate.isAfter(middleDate))return dateBinarySearch(seachDate,lowIndex,middleIndex-1);return dateBinarySearch(seachDate,middleIndex,highIndex)};sortAscending?(lastIndex=layout.qListObject.qDataPages[0].qMatrix.length-1,lowIndex=dateBinarySearch(pickStart,0,lastIndex),highIndex=dateBinarySearch(pickEnd,lowIndex,lastIndex),qElemNumbers=layout.qListObject.qDataPages[0].qMatrix.slice(lowIndex,highIndex+1).map((function(fieldValue){return fieldValue[0].qElemNumber}))):(lastIndex=layout.qListObject.qDataPages[0].qMatrix.length-1,lowIndex=dateBinarySearch(pickEnd,0,lastIndex),highIndex=dateBinarySearch(pickStart,lowIndex,lastIndex),qElemNumbers=layout.qListObject.qDataPages[0].qMatrix.slice(lowIndex,highIndex+1).map((function(fieldValue){var date=createMoment(fieldValue[0].qText,qlikDateFormat);return date.isSame(pickEnd)||date.isSame(pickStart)||date.isBefore(pickEnd)&&date.isAfter(pickStart)?fieldValue[0].qElemNumber:-1}))),self.backendApi.selectValues(0,qElemNumbers,!1)}}))}}}));